<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Wiring Puzzle</title>
  <style>
    /* minimal styling – make sockets and wires look like your Tk version */
    .wire { padding:4px; margin:2px; cursor:grab; border:1px solid #444; display:inline-block; }
    .socket { width:60px; height:60px; border:2px dashed #aaa; margin:4px; position:relative; }
    .socket.filled { border-style:solid; }
    .label { font-family:Consolas, monospace; font-size:12px; }
  </style>
</head>
<body>
  <div id="rules" class="label"></div>
  <button id="hintBtn" style="display:none;"></button>
  <div id="wires"></div>
  <div id="sockets"></div>
  <button id="checkBtn">Check</button>

  <script src="pyodide/pyodide.js"></script> <!-- copy Pyodide dist into modules/my-puzzle/pyodide/ -->
  <script type="module">
    const pyodide = await loadPyodide({indexURL: "modules/my-puzzle/pyodide/"});
    // load your python file
    const core = await (await fetch("modules/my-puzzle/puzzle_core.py")).text();
    await pyodide.runPython(core);

    // call Python
    const puz = pyodide.runPython(`get_puzzle(seed=None, min_rules=5)`);
    // puz is a PyProxy. Convert to JS
    const puzzle = puz.toJs({dict:true});
    puz.destroy();

    // --- render rules & hint
    const rulesDiv = document.getElementById("rules");
    rulesDiv.innerHTML = "<b>Magos Edicts</b><br>" + puzzle.rules.map(r => "• "+r).join("<br>");
    if (puzzle.hint){
      const hb = document.getElementById("hintBtn");
      hb.style.display="inline-block";
      hb.textContent = "Hint";
      hb.onclick = ()=> alert(puzzle.hint);
    }

    // --- render wires
    const COLORS = ["Black","Blue","White","Red","Orange","Green"];
    const wiresDiv = document.getElementById("wires");
    COLORS.forEach(c=>{
      const el=document.createElement("div");
      el.className="wire";
      el.dataset.color=c;
      el.textContent=c;
      el.draggable=true;
      el.addEventListener("dragstart", ev=>ev.dataTransfer.setData("color", c));
      wiresDiv.appendChild(el);
    });

    // --- render sockets
    const socketsDiv=document.getElementById("sockets");
    const n = puzzle.board.symbols.length;
    const sockets=[];
    for(let i=0;i<n;i++){
      const s=document.createElement("div");
      s.className="socket";
      s.dataset.idx=i;
      s.innerHTML=`<div class="label" style="position:absolute;top:2px;left:2px;">${puzzle.board.symbols[i]}</div>`;
      s.addEventListener("dragover", ev=>ev.preventDefault());
      s.addEventListener("drop", ev=>{
        ev.preventDefault();
        const color=ev.dataTransfer.getData("color");
        placeWire(color, i);
      });
      socketsDiv.appendChild(s);
      sockets.push(s);
    }

    const placement = {}; // color -> idx
    function placeWire(color, idx){
      // remove existing occupancy
      for(const [c, p] of Object.entries(placement)){
        if(p===idx){ delete placement[c]; clearSocket(idx); }
      }
      // if color already placed, free old socket
      if(placement[color]!=null) clearSocket(placement[color]);

      placement[color]=idx;
      const sock=sockets[idx];
      sock.classList.add("filled");
      sock.textContent="";
      sock.style.background=color.toLowerCase();
      sock.style.color=(["white","yellow"].includes(color.toLowerCase())?"black":"white");
      sock.textContent=color;
    }
    function clearSocket(idx){
      const sock=sockets[idx];
      sock.classList.remove("filled");
      sock.removeAttribute("style");
      sock.textContent="";
      sock.innerHTML=`<div class="label" style="position:absolute;top:2px;left:2px;">${puzzle.board.symbols[idx]}</div>`;
    }

    document.getElementById("checkBtn").onclick=()=>{
      // build tuple like Python solution
      const guess = COLORS.map(c=> placement[c] ?? -1);
      if(guess.includes(-1)){ alert("Wire all sockets first."); return; }
      const correct = JSON.stringify(guess) === JSON.stringify(puzzle.solution);
      alert(correct ? "Access granted!" : "Incorrect wiring.");
      if(correct){
        // tell Foundry parent we're done
        window.parent.postMessage({type:"puzzle-solved"}, "*");
      }
    };
  </script>
</body>
</html>
